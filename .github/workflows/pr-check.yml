name: PR Check

run-name: >-
  ${{ inputs.is_merge_group == 'true' && format('Merge queue check - {0}', inputs.repo_name) || (inputs.pr_number != '' && format('PR check #{0} - {1}', inputs.pr_number, inputs.repo_name) || format('PR check - {0}', inputs.repo_name)) }}

on:
  workflow_dispatch:
    inputs:
      repo_owner:
        description: 'Repository owner'
        required: true
        type: string
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      pr_number:
        description: 'Pull request number (empty for merge_group)'
        required: false
        type: string
        default: ''
      head_sha:
        description: 'Head commit SHA to validate'
        required: true
        type: string
      base_branch:
        description: 'Target branch (for merge_group, passed directly; for PR, from pr-info)'
        required: false
        type: string
        default: ''
      is_merge_group:
        description: 'Whether this is a merge_group event'
        required: false
        type: string
        default: 'false'

permissions:
  contents: read
  checks: write
  statuses: write

jobs:
  pre-check:
    name: Pre-Check Configuration
    runs-on: ubuntu-latest
    outputs:
      validation_status: ${{ steps.validate.outputs.status }}
      validation_message: ${{ steps.validate.outputs.message }}
      head_branch: ${{ inputs.is_merge_group == 'true' && '' || steps.pr-info.outputs.head_ref }}
      base_branch: ${{ inputs.is_merge_group == 'true' && inputs.base_branch || steps.pr-info.outputs.base_ref }}
      should_skip_pr_steps: ${{ inputs.is_merge_group == 'true' }}
    steps:
      - name: Print Input Parameters
        run: |
          echo "::group::Workflow Inputs"
          echo "repo_owner: ${{ inputs.repo_owner }}"
          echo "repo_name: ${{ inputs.repo_name }}"
          echo "pr_number: ${{ inputs.pr_number }}"
          echo "head_sha: ${{ inputs.head_sha }}"
          echo "base_branch: ${{ inputs.base_branch }}"
          echo "is_merge_group: ${{ inputs.is_merge_group }}"
          echo "::endgroup::"

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Get Pull Request Information
        id: pr-info
        if: inputs.is_merge_group != 'true'
        uses: folio-org/kitfox-github/.github/actions/get-pr-info@master
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          pr_number: ${{ inputs.pr_number }}
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Check Commit in PR
        id: check-commit
        if: inputs.is_merge_group != 'true' && steps.pr-info.outputs.pr_exists == 'true'
        uses: folio-org/kitfox-github/.github/actions/is-commit-in-pr@master
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          pr_number: ${{ inputs.pr_number }}
          commit_sha: ${{ inputs.head_sha }}
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Checkout Repository
        if: inputs.is_merge_group == 'true' || (steps.pr-info.outputs.pr_exists == 'true' && steps.check-commit.outputs.commit_found == 'true')
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          ref: ${{ inputs.head_sha }}
          token: ${{ steps.app-token.outputs.token }}

      - name: Get Update Configuration
        id: get-config
        if: inputs.is_merge_group == 'true' || (steps.pr-info.outputs.pr_exists == 'true' && steps.check-commit.outputs.commit_found == 'true')
        uses: folio-org/kitfox-github/.github/actions/get-update-config@master
        with:
          repo: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          branch: master
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Validate Configuration
        id: validate
        if: inputs.is_merge_group == 'true' || (steps.pr-info.outputs.pr_exists == 'true' && steps.check-commit.outputs.commit_found == 'true')
        env:
          TARGET_BRANCH: ${{ inputs.is_merge_group == 'true' && inputs.base_branch || steps.pr-info.outputs.base_ref }}
          HEAD_BRANCH: ${{ steps.pr-info.outputs.head_ref }}
          PR_LABELS: ${{ steps.pr-info.outputs.labels }}
          CONFIG_EXISTS: ${{ steps.get-config.outputs.config_exists }}
          ENABLED: ${{ steps.get-config.outputs.enabled }}
          RELEASE_BRANCHES: ${{ steps.get-config.outputs.branches }}
          BRANCH_CONFIG: ${{ steps.get-config.outputs.branch_config }}
          REQUIRED_LABELS: ${{ steps.get-config.outputs.pr_labels }}
          IS_MERGE_GROUP: ${{ inputs.is_merge_group }}
        run: |
          echo "::notice::Validating configuration for branch $TARGET_BRANCH"

          if [[ "$CONFIG_EXISTS" != "true" ]]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=Release configuration file not found" >> "$GITHUB_OUTPUT"
            echo "::warning::Configuration file not found: .github/release-config.yml"
            exit 0
          fi

          if [[ "$ENABLED" != "true" ]]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=Release scanning is disabled in configuration" >> "$GITHUB_OUTPUT"
            echo "::notice::Release scanning is disabled"
            exit 0
          fi

          BRANCH_EXISTS=$(echo "$RELEASE_BRANCHES" | jq -r ".[] | select(. == \"$TARGET_BRANCH\")" 2>/dev/null)
          if [ -z "$BRANCH_EXISTS" ]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=Target branch $TARGET_BRANCH is not configured for release scanning" >> "$GITHUB_OUTPUT"
            echo "::notice::Branch $TARGET_BRANCH is not in release_branches configuration"
            exit 0
          fi

          BRANCH_ENTRY=$(echo "$BRANCH_CONFIG" | jq -r ".[] | select(.branch == \"$TARGET_BRANCH\")")
          NEED_PR=$(echo "$BRANCH_ENTRY" | jq -r ".need_pr // false")
          UPDATE_BRANCH=$(echo "$BRANCH_ENTRY" | jq -r ".update_branch // empty")

          if [[ "$NEED_PR" != "true" ]]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=Branch $TARGET_BRANCH is not configured for PR-based updates" >> "$GITHUB_OUTPUT"
            echo "::notice::Branch $TARGET_BRANCH has need_pr=false, skipping PR check"
            exit 0
          fi

          if [[ "$IS_MERGE_GROUP" != "true" ]] && [[ "$HEAD_BRANCH" != "$UPDATE_BRANCH" ]]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=PR head branch '$HEAD_BRANCH' does not match configured update branch '$UPDATE_BRANCH'" >> "$GITHUB_OUTPUT"
            echo "::notice::Head branch '$HEAD_BRANCH' is not the configured update branch '$UPDATE_BRANCH', skipping"
            exit 0
          fi

          if [[ "$IS_MERGE_GROUP" != "true" ]] && [ -n "$REQUIRED_LABELS" ]; then
            echo "::notice::Checking for required labels: $REQUIRED_LABELS"
            PR_LABELS_ARRAY=$(echo "$PR_LABELS" | jq -r '.[]' 2>/dev/null || echo "")
            MISSING_LABELS=""

            # Convert comma-separated labels to array
            IFS=',' read -ra LABEL_ARRAY <<< "$REQUIRED_LABELS"
            for label in "${LABEL_ARRAY[@]}"; do
              label=$(echo "$label" | xargs) # Trim whitespace
              if ! echo "$PR_LABELS_ARRAY" | grep -q "^$label$"; then
                MISSING_LABELS="${MISSING_LABELS}${MISSING_LABELS:+, }$label"
              fi
            done

            if [ -n "$MISSING_LABELS" ]; then
              echo "status=skipped" >> "$GITHUB_OUTPUT"
              echo "message=PR is missing required labels: $MISSING_LABELS" >> "$GITHUB_OUTPUT"
              echo "::notice::PR does not have required labels, skipping validation"
              exit 0
            fi
          fi

          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "message=Configuration validation passed" >> "$GITHUB_OUTPUT"
          echo "::notice::Configuration validation successful"


  check:
    name: Check commit
    needs: pre-check
    if: needs.pre-check.outputs.validation_status == 'success'
    runs-on: ubuntu-latest
    outputs:
      descriptor_exists: ${{ steps.check-descriptor.outputs.exists }}
      descriptor_file: ${{ steps.check-descriptor.outputs.descriptor_file }}
      validation_passed: ${{ steps.validate.outputs.validation_passed }}
      platform_found: ${{ steps.fetch-platform.outputs.platform_found }}
      failure_reason: ${{ steps.check-descriptor.outputs.exists != 'true' && steps.check-descriptor.outputs.failure_reason || steps.validate.outputs.failure_reason || 'Check workflow logs for details' }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          ref: ${{ inputs.head_sha }}
          token: ${{ steps.app-token.outputs.token }}

      - name: Create Check Run
        id: create-check
        uses: actions/github-script@v7
        env:
          IS_MERGE_GROUP: ${{ inputs.is_merge_group }}
          PR_NUMBER: ${{ inputs.pr_number }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const isMergeGroup = process.env.IS_MERGE_GROUP === 'true';
            const prNumber = process.env.PR_NUMBER;

            const summary = isMergeGroup
              ? 'Starting merge queue validation...'
              : `Starting application verification for PR #${prNumber}...`;

            const detailsUrl = isMergeGroup
              ? `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              : `https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/pull/${prNumber}`;

            const { data: checkRun } = await github.rest.checks.create({
              owner: '${{ inputs.repo_owner }}',
              repo: '${{ inputs.repo_name }}',
              name: 'eureka-ci / validate-application',
              head_sha: '${{ inputs.head_sha }}',
              status: 'in_progress',
              started_at: new Date().toISOString(),
              output: {
                title: 'Application Verification',
                summary: summary
              },
              details_url: detailsUrl
            });

            console.log(`Created check run with ID: ${checkRun.id}`);
            core.setOutput('check_run_id', checkRun.id);

      - name: Check Existing Descriptor
        id: check-descriptor
        env:
          DESCRIPTOR_FILE: "application.lock.json"
        run: |
          set -eo pipefail

          if [[ ! -f "$DESCRIPTOR_FILE" ]]; then
            echo "::error::Application descriptor not found: $DESCRIPTOR_FILE"
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "failure_reason=Application descriptor file not found: $DESCRIPTOR_FILE" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::notice::Found existing application descriptor: $DESCRIPTOR_FILE"
          echo "exists=true" >> "$GITHUB_OUTPUT"
          echo "descriptor_file=$DESCRIPTOR_FILE" >> "$GITHUB_OUTPUT"

      - name: Fetch Platform Descriptor
        id: fetch-platform
        if: steps.check-descriptor.outputs.exists == 'true'
        env:
          BRANCH: ${{ needs.pre-check.outputs.base_branch }}
        run: |
          set -eo pipefail
          mkdir -p /tmp/platform

          echo "::notice::Fetching platform descriptor from platform-lsp branch: $BRANCH"

          http_code=$(curl -sS -w "%{http_code}" -o /tmp/platform/platform-descriptor.json \
            "https://raw.githubusercontent.com/folio-org/platform-lsp/$BRANCH/platform-descriptor.json")

          if [ "$http_code" = "200" ]; then
            echo "::notice::Platform descriptor fetched successfully from branch: $BRANCH"
            echo "platform_found=true" >> "$GITHUB_OUTPUT"
            echo "platform_descriptor_path=/tmp/platform/platform-descriptor.json" >> "$GITHUB_OUTPUT"
          elif [ "$http_code" = "404" ]; then
            echo "::warning::Platform descriptor not found for branch $BRANCH (HTTP 404)"
            echo "::warning::Dependency validation will be skipped"
            echo "platform_found=false" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Failed to fetch platform descriptor from branch $BRANCH (HTTP $http_code)"
            echo "::error::This might be a temporary issue. Please retry the check."
            echo "platform_found=false" >> "$GITHUB_OUTPUT"
            echo "fetch_error=true" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Update Check Run - Validating
        if: steps.check-descriptor.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.checks.update({
              owner: '${{ inputs.repo_owner }}',
              repo: '${{ inputs.repo_name }}',
              check_run_id: ${{ steps.create-check.outputs.check_run_id }},
              status: 'in_progress',
              output: {
                title: 'Application Verification',
                summary: 'Validating application descriptor and dependencies...'
              }
            });

      - name: Validate Application
        id: validate
        if: steps.check-descriptor.outputs.exists == 'true'
        uses: folio-org/kitfox-github/.github/actions/validate-application@master
        with:
          app_name: ${{ inputs.repo_name }}
          app_descriptor_path: ${{ steps.check-descriptor.outputs.descriptor_file }}
          platform_descriptor_path: ${{ steps.fetch-platform.outputs.platform_descriptor_path }}
          use_platform_descriptor: ${{ steps.fetch-platform.outputs.platform_found == 'true' && 'true' || 'false' }}
          rely_on_FAR: 'false'
          far_url: ${{ vars.FAR_URL }}

      - name: Finalize Check Run
        if: always()
        uses: actions/github-script@v7
        env:
          IS_MERGE_GROUP: ${{ inputs.is_merge_group }}
          PR_NUMBER: ${{ inputs.pr_number }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const isMergeGroup = process.env.IS_MERGE_GROUP === 'true';
            const prNumber = process.env.PR_NUMBER;

            let conclusion, title, summary;
            const descriptorExists = '${{ steps.check-descriptor.outputs.exists }}';
            const descriptorFailureReason = '${{ steps.check-descriptor.outputs.failure_reason }}';
            const validationPassed = '${{ steps.validate.outputs.validation_passed }}';
            const failureReason = '${{ steps.validate.outputs.failure_reason }}';
            const platformFound = '${{ steps.fetch-platform.outputs.platform_found }}';
            const fetchError = '${{ steps.fetch-platform.outputs.fetch_error }}';
            const fetchOutcome = '${{ steps.fetch-platform.outcome }}';

            if (descriptorExists !== 'true') {
              conclusion = 'failure';
              title = 'Descriptor Not Found';
              summary = descriptorFailureReason || 'Application descriptor file not found';
            } else if (fetchError === 'true' || fetchOutcome === 'failure') {
              conclusion = 'failure';
              title = 'Platform Descriptor Fetch Failed';
              summary = `Failed to fetch platform descriptor from branch ${{ needs.pre-check.outputs.base_branch }}. This might be a temporary issue. Please retry.`;
            } else if (validationPassed === 'false') {
              conclusion = 'failure';
              title = 'Verification Failed';
              summary = failureReason || 'Application verification failed. Check the logs for details.';
            } else if (validationPassed === 'true') {
              conclusion = 'success';
              title = 'All Checks Passed';
              summary = platformFound === 'false'
                ? 'Application verification completed successfully (dependency validation skipped - platform descriptor not found)'
                : 'Application verification completed successfully';
            } else {
              conclusion = 'neutral';
              title = 'Check Incomplete';
              summary = 'Some checks could not be completed';
            }

            const contextInfo = isMergeGroup
              ? `**Merge Queue Validation**\n**Target Branch:** \`${{ needs.pre-check.outputs.base_branch }}\``
              : `**Pull Request:** [#${prNumber}](https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/pull/${prNumber})\n**Branch:** \`${{ needs.pre-check.outputs.head_branch }}\``;

            let verificationSection = '';
            if (descriptorExists === 'true') {
              verificationSection = `
            ### Application Verification
            - **Passed:** ${validationPassed || 'unknown'}
            ${failureReason ? `- **Reason:** ${failureReason}` : ''}`;
            }

            const text = `
            ## Application Verification Results

            ${contextInfo}
            **Commit:** \`${{ inputs.head_sha }}\`

            ### Validation Status
            - **Result:** ${{ needs.pre-check.outputs.validation_status || 'unknown' }}
            - **Message:** ${{ needs.pre-check.outputs.validation_message || 'No message' }}

            ### Descriptor Status
            - **Found:** ${descriptorExists || 'false'}
            ${verificationSection}

            ### Workflow Run
            - **Run ID:** ${{ github.run_id }}
            - **Run Number:** ${{ github.run_number }}
            - **Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `;

            const updateParams = {
              owner: '${{ inputs.repo_owner }}',
              repo: '${{ inputs.repo_name }}',
              check_run_id: ${{ steps.create-check.outputs.check_run_id }},
              status: 'completed',
              conclusion: conclusion,
              completed_at: new Date().toISOString(),
              output: {
                title: title,
                summary: summary,
                text: text
              },
              details_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            };

            if (descriptorExists !== 'true' || fetchError === 'true' || validationPassed === 'false') {
              updateParams.actions = [{
                label: 'Re-run Validation',
                description: 'Trigger a new validation check',
                identifier: 're-run-validation'
              }];
            }

            await github.rest.checks.update(updateParams);


  notify:
    name: Send Notifications
    needs: [pre-check, check]
    if: always() && !cancelled() && needs.pre-check.outputs.validation_status == 'success'
    runs-on: ubuntu-latest
    outputs:
      team_channel: ${{ steps.get-vars.outputs.team_channel }}
    env:
      IS_MERGE_GROUP: ${{ inputs.is_merge_group }}
      TITLE_TEXT: "${{ inputs.repo_name }} ${{ inputs.is_merge_group == 'true' && 'merge queue' || 'release update' }} check ${{ (needs.check.result == 'success' && needs.check.outputs.validation_passed == 'true') && 'passed' || 'failed' }}"
      TITLE_BLOCK: |
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*${{ inputs.repo_name }} ${{ inputs.is_merge_group == 'true' && 'merge queue' || 'release update' }} check ${{ (needs.check.result == 'success' && needs.check.outputs.validation_passed == 'true') && 'passed' || 'failed' }} <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>*"
          }
        }
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Get Repository Variables
        id: get-vars
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            try {
              const { data: variable } = await github.rest.actions.getRepoVariable({
                owner: '${{ inputs.repo_owner }}',
                repo: '${{ inputs.repo_name }}',
                name: 'SLACK_NOTIF_CHANNEL'
              });
              console.log(`Found SLACK_NOTIF_CHANNEL: ${variable.value}`);
              core.setOutput('team_channel', variable.value);
            } catch (error) {
              console.log(`SLACK_NOTIF_CHANNEL not found or not accessible: ${error.message}`);
              core.setOutput('team_channel', '');
            }

      - name: Build Notification Attachment
        id: build-attachment
        env:
          BASE_BRANCH: ${{ needs.pre-check.outputs.base_branch }}
          HEAD_BRANCH: ${{ needs.pre-check.outputs.head_branch }}
          CHECK_PASSED: ${{ needs.check.result == 'success' && needs.check.outputs.validation_passed == 'true' }}
          FAILURE_REASON: ${{ needs.check.outputs.failure_reason }}
        run: |
          if [[ "$IS_MERGE_GROUP" == "true" ]]; then
            ATTACHMENT=$(cat <<EOF
          {
            "color": "${{ (needs.check.result == 'success' && needs.check.outputs.validation_passed == 'true') && 'good' || 'danger' }}",
            "fields": [
              {
                "title": "Target branch",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/tree/${BASE_BRANCH}|${BASE_BRANCH}>",
                "short": true
              },
              {
                "title": "Commit",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }}|${{ inputs.head_sha }}>",
                "short": true
              }${{ (needs.check.result != 'success' || needs.check.outputs.validation_passed != 'true') && format(',
              {{
                "title": "Failure Reason",
                "value": "{0}",
                "short": false
              }}', needs.check.outputs.failure_reason) || '' }}
            ],
            "footer": "Eureka CI/CD - Merge Queue"
          }
          EOF
          )
          else
            ATTACHMENT=$(cat <<EOF
          {
            "color": "${{ (needs.check.result == 'success' && needs.check.outputs.validation_passed == 'true') && 'good' || 'danger' }}",
            "fields": [
              {
                "title": "Release branch",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/tree/${BASE_BRANCH}|${BASE_BRANCH}>",
                "short": true
              },
              {
                "title": "Update branch",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/tree/${HEAD_BRANCH}|${HEAD_BRANCH}>",
                "short": true
              },
              {
                "title": "PR Number",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/pull/${{ inputs.pr_number }}|#${{ inputs.pr_number }}>",
                "short": true
              },
              {
                "title": "Commit",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }}|${{ inputs.head_sha }}>",
                "short": true
              }${{ (needs.check.result != 'success' || needs.check.outputs.validation_passed != 'true') && format(',
              {{
                "title": "Failure Reason",
                "value": "{0}",
                "short": false
              }}', needs.check.outputs.failure_reason) || '' }}
            ],
            "footer": "Eureka CI/CD"
          }
          EOF
          )
          fi
          echo "ATTACHMENT<<EOF" >> "$GITHUB_ENV"
          echo "$ATTACHMENT" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Send to Team Channel
        if: steps.get-vars.outputs.team_channel != ''
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ steps.get-vars.outputs.team_channel }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ env.ATTACHMENT }}
              ]
            }

      - name: Send to General Channel
        if: vars.GENERAL_SLACK_NOTIF_CHANNEL != ''
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ env.ATTACHMENT }}
              ]
            }

  summarize:
    name: Workflow Summary
    needs: [pre-check, check, notify]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Workflow Summary
        env:
          PRE_CHECK_RESULT: ${{ needs.pre-check.result }}
          VALIDATION_STATUS: ${{ needs.pre-check.outputs.validation_status }}
          VALIDATION_MESSAGE: ${{ needs.pre-check.outputs.validation_message }}
          CHECK_RESULT: ${{ needs.check.result }}
          DESCRIPTOR_EXISTS: ${{ needs.check.outputs.descriptor_exists }}
          VALIDATION_PASSED: ${{ needs.check.outputs.validation_passed }}
          FAILURE_REASON: ${{ needs.check.outputs.failure_reason }}
          HEAD_BRANCH: ${{ needs.pre-check.outputs.head_branch }}
          BASE_BRANCH: ${{ needs.pre-check.outputs.base_branch }}
          IS_MERGE_GROUP: ${{ inputs.is_merge_group }}
        run: |
          {
            if [[ "$IS_MERGE_GROUP" == "true" ]]; then
              echo "### Merge Queue Check Summary"
            else
              echo "### PR Check Summary"
            fi
            echo ""
            echo "**Repository:** \`${{ inputs.repo_owner }}/${{ inputs.repo_name }}\`"

            if [[ "$IS_MERGE_GROUP" == "true" ]]; then
              echo "**Target Branch:** \`$BASE_BRANCH\`"
            else
              echo "**PR:** [#${{ inputs.pr_number }}](https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/pull/${{ inputs.pr_number }})"
            fi
            echo "**Commit:** [\`${{ inputs.head_sha }}\`](https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }})"
            echo ""

            echo "### Pre-Check Status"
            echo ""
            if [[ "$PRE_CHECK_RESULT" == "success" ]]; then
              if [[ "$VALIDATION_STATUS" == "success" ]]; then
                echo "**Pre-Check:** Passed"
                echo "- **Base Branch:** $BASE_BRANCH"
                if [[ "$IS_MERGE_GROUP" != "true" ]]; then
                  echo "- **Head Branch:** $HEAD_BRANCH"
                fi
                echo "- **Message:** $VALIDATION_MESSAGE"
              elif [[ "$VALIDATION_STATUS" == "skipped" ]]; then
                echo "**Pre-Check:** Skipped"
                echo "- **Reason:** $VALIDATION_MESSAGE"
              elif [[ -z "$VALIDATION_STATUS" ]]; then
                echo "**Pre-Check:** Validation step was skipped"
                if [[ "$IS_MERGE_GROUP" != "true" ]]; then
                  echo "- This typically means the PR was not found or the commit is not in the PR"
                fi
              else
                echo "**Pre-Check:** Unknown status ($VALIDATION_STATUS)"
              fi
            elif [[ "$PRE_CHECK_RESULT" == "failure" ]]; then
              echo "**Pre-Check:** Failed"
              echo "- **Message:** $VALIDATION_MESSAGE"
            elif [[ "$PRE_CHECK_RESULT" == "cancelled" ]]; then
              echo "**Pre-Check:** Cancelled"
            else
              echo "**Pre-Check:** Skipped"
            fi

            echo ""
            echo "### Application Check Status"
            echo ""

            if [[ "$VALIDATION_STATUS" != "success" ]]; then
              echo "Application check was skipped due to pre-check status"
            elif [[ "$CHECK_RESULT" == "success" ]]; then
              if [[ "$VALIDATION_PASSED" == "true" ]]; then
                echo "**Application Check:** Passed"
                echo "- **Descriptor Found:** $DESCRIPTOR_EXISTS"
                echo "- **Validation:** Passed"
              else
                echo "**Application Check:** Failed"
                echo "- **Descriptor Found:** $DESCRIPTOR_EXISTS"
                if [[ -n "$FAILURE_REASON" ]]; then
                  echo "- **Failure Reason:** $FAILURE_REASON"
                fi
              fi
            elif [[ "$CHECK_RESULT" == "failure" ]]; then
              echo "**Application Check:** Failed"
              echo "- **Descriptor Found:** $DESCRIPTOR_EXISTS"
              if [[ -n "$FAILURE_REASON" ]]; then
                echo "- **Failure Reason:** $FAILURE_REASON"
              else
                echo "- Check the workflow logs for details"
              fi
            elif [[ "$CHECK_RESULT" == "cancelled" ]]; then
              echo "**Application Check:** Cancelled"
            else
              echo "**Application Check:** Skipped"
            fi

            echo ""
            echo "### Notification Status"
            echo ""

            if [[ -n "${{ needs.notify.outputs.team_channel }}" ]]; then
              if [[ "${{ needs.notify.result }}" == "success" ]]; then
                echo "**Team Channel** (\`${{ needs.notify.outputs.team_channel }}\`): Sent"
              elif [[ "${{ needs.notify.result }}" == "failure" ]]; then
                echo "**Team Channel** (\`${{ needs.notify.outputs.team_channel }}\`): Failed"
              else
                echo "**Team Channel** (\`${{ needs.notify.outputs.team_channel }}\`): Skipped"
              fi
            else
              echo "**Team Channel:** Not configured"
            fi

            echo ""

            if [[ -n "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}" ]]; then
              if [[ "${{ needs.notify.result }}" == "success" ]]; then
                echo "**General Channel** (\`${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}\`): Sent"
              elif [[ "${{ needs.notify.result }}" == "failure" ]]; then
                echo "**General Channel** (\`${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}\`): Failed"
              else
                echo "**General Channel** (\`${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}\`): Skipped"
              fi
            else
              echo "**General Channel:** Not configured"
            fi

            echo ""
            echo "---"
            echo ""
            echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> $GITHUB_STEP_SUMMARY