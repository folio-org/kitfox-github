name: Branch Ruleset Automation

run-name: >-
  Branch ruleset update â€¢ ${{ inputs.repo_owner }}/${{ inputs.repo_name }}

on:
  workflow_dispatch:
    inputs:
      repo_owner:
        description: 'Repository owner'
        required: true
        type: string
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      head_sha:
        description: 'Commit SHA that triggered the update'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  update-rulesets:
    name: Update Branch Rulesets
    runs-on: ubuntu-latest
    outputs:
      branches_updated: ${{ steps.update-rulesets.outputs.branches_updated }}
      branches_skipped: ${{ steps.update-rulesets.outputs.branches_skipped }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Get Update Configuration
        id: get-config
        uses: folio-org/kitfox-github/.github/actions/get-update-config@master
        with:
          repo: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          branch: master
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Check Configuration
        id: check-config
        env:
          CONFIG_EXISTS: ${{ steps.get-config.outputs.config_exists }}
          ENABLED: ${{ steps.get-config.outputs.enabled }}
          RELEASE_BRANCHES: ${{ steps.get-config.outputs.branches }}
        run: |
          if [[ "$CONFIG_EXISTS" != "true" ]]; then
            echo "::warning::Configuration file not found: .github/update-config.yml"
            echo "should_continue=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$ENABLED" != "true" ]]; then
            echo "::notice::Release scanning is disabled in configuration"
            echo "should_continue=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BRANCH_COUNT=$(echo "$RELEASE_BRANCHES" | jq -r 'length')
          if [[ "$BRANCH_COUNT" == "0" ]]; then
            echo "::notice::No release branches configured"
            echo "should_continue=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::notice::Found $BRANCH_COUNT release branches to configure"
          echo "should_continue=true" >> "$GITHUB_OUTPUT"

      - name: Update Branch Rulesets
        id: update-rulesets
        if: steps.check-config.outputs.should_continue == 'true'
        uses: folio-org/kitfox-github/.github/actions/update-branch-rulesets@master
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          branches: ${{ steps.get-config.outputs.branches }}
          github_token: ${{ steps.app-token.outputs.token }}


  summarize:
    name: Workflow Summary
    needs: update-rulesets
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Workflow Summary
        env:
          BRANCHES_UPDATED: ${{ needs.update-rulesets.outputs.branches_updated }}
          BRANCHES_SKIPPED: ${{ needs.update-rulesets.outputs.branches_skipped }}
          JOB_STATUS: ${{ needs.update-rulesets.result }}
        run: |
          {
            echo "### Branch Ruleset Automation Summary"
            echo ""
            echo "**Repository:** \`${{ inputs.repo_owner }}/${{ inputs.repo_name }}\`"
            if [[ -n "${{ inputs.head_sha }}" ]]; then
              echo "**Trigger Commit:** [\`${{ inputs.head_sha }}\`](https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }})"
            fi
            echo ""

            echo "### Ruleset Configuration"
            echo ""
            echo "Each configured branch will have:"
            echo "- Required status check: \`eureka-ci / validate-application\`"
            echo "- Merge queue enabled (SQUASH merge, ALLGREEN strategy)"
            echo "- Pull request reviews required (1 approval)"
            echo ""

            echo "### Results"
            echo ""
            if [[ "$JOB_STATUS" == "success" ]]; then
              echo "**Status:** Completed successfully"
            elif [[ "$JOB_STATUS" == "failure" ]]; then
              echo "**Status:** Completed with errors"
            else
              echo "**Status:** $JOB_STATUS"
            fi

            echo ""
            echo "**Branches Updated:** $BRANCHES_UPDATED"
            echo ""
            echo "**Branches Skipped:** $BRANCHES_SKIPPED"

            echo ""
            echo "---"
            echo ""
            echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> $GITHUB_STEP_SUMMARY