name: Release update (Reusable)

run-name: ${{ inputs.release_branch }} release update

on:
  workflow_call:
    inputs:
      release_branch:
        description: 'Release branch to scan'
        required: true
        type: string
      update_branch:
        description: 'Update branch name for this release branch'
        required: true
        type: string
      dry_run:
        description: 'Perform dry run without creating PRs'
        required: false
        type: boolean
        default: false
      pr_reviewers:
        description: 'Comma-separated list of reviewers'
        required: false
        type: string
        default: ''
      pr_labels:
        description: 'Comma-separated list of labels'
        required: false
        type: string
        default: ''
    outputs:
      scan_result:
        description: 'Result of the scan (success/failure/skipped)'
        value: ${{ jobs.scan.result }}
      updated:
        description: 'Whether updates were found'
        value: ${{ jobs.scan.outputs.updated }}
      pr_created:
        description: 'Whether a PR was created'
        value: ${{ jobs.scan.outputs.pr_created }}
      pr_url:
        description: 'URL of the created PR'
        value: ${{ jobs.scan.outputs.pr_url }}
      workflow_status:
        description: 'Overall workflow status'
        value: ${{ jobs.scan.outputs.workflow_status }}
      failure_reason:
        description: 'Reason for workflow failure if any'
        value: ${{ jobs.scan.outputs.failure_reason }}

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: release-scan-${{ github.repository }}-${{ inputs.release_branch }}
  cancel-in-progress: false

jobs:
  scan:
    name: Scan Branch
    uses: ./.github/workflows/release-update-flow.yml
    with:
      app_name: ${{ github.event.repository.name }}
      repo: ${{ github.repository }}
      release_branch: ${{ inputs.release_branch }}
      update_branch: ${{ inputs.update_branch }}
      workflow_run_number: ${{ github.run_number }}
      dry_run: ${{ inputs.dry_run }}
      pr_reviewers: ${{ inputs.pr_reviewers }}
      pr_labels: ${{ inputs.pr_labels }}
    secrets: inherit

  notify:
    name: Send Notifications
    needs: scan
    if: always() && !cancelled() && needs.scan.outputs.updated == 'true' && !inputs.dry_run
    runs-on: ubuntu-latest
    outputs:
      team_notif_status: ${{ steps.notify-team.outcome }}
      general_notification_status: ${{ steps.notify-general.outcome }}
    env:
      TITLE_TEXT: "${{ github.event.repository.name }} ${{ inputs.release_branch }} release ${{ needs.scan.result == 'success' && 'updated' || 'failed' }} #${{ github.run_number }}"
      TITLE_BLOCK: |
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*${{ github.event.repository.name }} ${{ inputs.release_branch }} release ${{ needs.scan.result == 'success' && 'updated' || 'failed' }} <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>*"
          }
        }
      SUCCESS_ATTACHMENT: |
        {
          "color": "good",
          "fields": [
            {
              "title": "Release Branch",
              "value": "<${{ github.server_url }}/${{ github.repository }}/tree/${{ inputs.release_branch }}|${{ inputs.release_branch }}>",
              "short": true
            },
            { "title": "New Version", "value": "${{ needs.scan.outputs.new_version }}", "short": true },
            { "title": "Updated", "value": "${{ needs.scan.outputs.updates_cnt }}", "short": true },
            {
              "title": "Pull Request",
              "value": "${{ needs.scan.outputs.pr_url != '' && format('<{0}|#{1}>', needs.scan.outputs.pr_url, needs.scan.outputs.pr_number) || 'No PR created' }}",
              "short": true
            }
          ]
        },
        {
          "color": "good",
          "mrkdwn_in": ["text"],
          "text": ${{ toJSON(needs.scan.outputs.updated_modules) }}
        },
        {
          "color": "${{ needs.scan.outputs.failed_reviewers != '' && 'warning' || 'good' }}",
          "mrkdwn_in": ["text"],
          "title": "${{ needs.scan.outputs.failed_reviewers != '' && 'Reviewers (failed)' || (needs.scan.outputs.successful_reviewers != '' && 'Reviewers (added)' || 'Reviewers') }}",
          "text": ${{ toJSON(needs.scan.outputs.failed_reviewers || needs.scan.outputs.successful_reviewers || 'No reviewers configured') }},
          "footer": "Eureka CI/CD"
        }
      FAILURE_ATTACHMENT: |
        {
          "color": "danger",
          "fields": [
            {
              "title": "Release Branch",
              "value": "<${{ github.server_url }}/${{ github.repository }}/tree/${{ inputs.release_branch }}|${{ inputs.release_branch }}>",
              "short": true
            },
            {
              "title": "Failure Reason",
              "value": "${{ needs.scan.outputs.failure_reason || 'Check workflow logs for details' }}",
              "short": false
            }
          ],
          "footer": "Eureka CI/CD"
        }
    steps:
      - name: Send to Team Channel
        id: notify-team
        if: vars.SLACK_NOTIF_CHANNEL != ''
        continue-on-error: true
        env:
          CHANNEL: ${{ vars.SLACK_NOTIF_CHANNEL }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ env.CHANNEL }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ needs.scan.result == 'success' && env.SUCCESS_ATTACHMENT || env.FAILURE_ATTACHMENT }}
              ]
            }

      - name: Send to General Channel
        id: notify-general
        if: vars.GENERAL_SLACK_NOTIF_CHANNEL != ''
        continue-on-error: true
        env:
          CHANNEL: ${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ env.CHANNEL }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ needs.scan.result == 'success' && env.SUCCESS_ATTACHMENT || env.FAILURE_ATTACHMENT }}
              ]
            }

  summarize:
    name: Branch Summary
    needs: [scan, notify]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Branch Summary
        env:
          BRANCH: ${{ inputs.release_branch }}
          SCAN_RESULT: ${{ needs.scan.result }}
          UPDATED: ${{ needs.scan.outputs.updated }}
          PR_CREATED: ${{ needs.scan.outputs.pr_created }}
          PR_URL: ${{ needs.scan.outputs.pr_url }}
          PR_NUMBER: ${{ needs.scan.outputs.pr_number }}
          NEW_VERSION: ${{ needs.scan.outputs.new_version }}
          UPDATES_CNT: ${{ needs.scan.outputs.updates_cnt }}
          UPDATED_MODULES: ${{ needs.scan.outputs.updated_modules }}
          SUCCESSFUL_REVIEWERS: ${{ needs.scan.outputs.successful_reviewers }}
          FAILED_REVIEWERS: ${{ needs.scan.outputs.failed_reviewers }}
          WORKFLOW_STATUS: ${{ needs.scan.outputs.workflow_status }}
          FAILURE_REASON: ${{ needs.scan.outputs.failure_reason }}
          TEAM_NOTIF_STATUS: ${{ needs.notify.outputs.team_notif_status || 'skipped' }}
          TEAM_NOTIF_STATUS_ICON: >-
            ${{ 
              needs.notify.outputs.team_notif_status == 'success' && 'âœ…'
              || needs.notify.outputs.team_notif_status == 'failure' && 'âš ï¸'
              || 'â„¹ï¸' 
            }}
          GENERAL_NOTIF_STATUS: ${{ needs.notify.outputs.general_notification_status || 'skipped' }}
          GENERAL_NOTIF_STATUS_ICON: >-
            ${{ 
              needs.notify.outputs.general_notification_status == 'success' && 'âœ…'
              || needs.notify.outputs.general_notification_status == 'failure' && 'âš ï¸'
              || 'â„¹ï¸' 
            }}
        run: |
          {
            echo "### ðŸŒ¿ Branch: \`$BRANCH\`"
            echo ""
            
            if [[ "$SCAN_RESULT" == "success" ]]; then
              if [[ "$UPDATED" == "true" ]]; then
                echo "âœ… **Scan Result:** Updates found"
                echo "- **New Version:** $NEW_VERSION"
                echo "- **Updates Count:** $UPDATES_CNT"
                if [[ "${{ inputs.dry_run }}" == "true" ]]; then
                  echo "- **Pull Request:** Not created (dry run mode)"
                elif [[ "$PR_CREATED" == "true" ]] && [[ -n "$PR_URL" ]]; then
                  echo "- **Pull Request:** [Created PR #$PR_NUMBER]($PR_URL)"
                elif [[ -n "$PR_URL" ]]; then
                  echo "- **Pull Request:** [Updated PR #$PR_NUMBER]($PR_URL)"
                elif [[ "$PR_CREATED" == "true" ]]; then
                  echo "- **Pull Request:** Created but URL not available"
                else
                  echo "- **Pull Request:** No PR created"
                fi
                
                if [[ -n "$UPDATED_MODULES" ]]; then
                  echo ""
                  echo "#### ðŸ“¦ Updated Modules:"
                  echo '```'
                  echo "$UPDATED_MODULES"
                  echo '```'
                fi
                
                if [[ "$PR_CREATED" == "true" ]]; then
                  if [[ -n "$FAILED_REVIEWERS" ]]; then
                    echo ""
                    echo "#### âš ï¸ Reviewer Assignment:"
                    echo "- **Failed:** $FAILED_REVIEWERS"
                    if [[ -n "$SUCCESSFUL_REVIEWERS" ]]; then
                      echo "- **Successful:** $SUCCESSFUL_REVIEWERS"
                    fi
                  elif [[ -n "$SUCCESSFUL_REVIEWERS" ]]; then
                    echo ""
                    echo "#### âœ… Reviewer Assignment:"
                    echo "- **Successful:** $SUCCESSFUL_REVIEWERS"
                  fi
                fi
              else
                echo "âœ… **Scan Result:** No updates needed"
                echo "- All modules are up to date"
              fi
            elif [[ "$SCAN_RESULT" == "failure" ]]; then
              echo "âŒ **Scan Result:** Failed"
              if [[ -n "$FAILURE_REASON" ]]; then
                echo "- **Reason:** $FAILURE_REASON"
              else
                echo "- Check the scan job logs for details"
              fi
            elif [[ "$SCAN_RESULT" == "cancelled" ]]; then
              echo "âš ï¸ **Scan Result:** Cancelled"
            else
              echo "â­ï¸ **Scan Result:** Skipped"
            fi
            
            echo ""
            
            echo "### ðŸ“¨ Notification Status"
            echo ""
            
            if [[ -n "${{ vars.SLACK_NOTIF_CHANNEL }}" ]]; then
              echo "$TEAM_NOTIF_STATUS_ICON **Team Channel** (\`${{ vars.SLACK_NOTIF_CHANNEL }}\`): $TEAM_NOTIF_STATUS"
            else
              echo "â„¹ï¸ **Team Channel:** No Slack channels configured"
            fi
              
            if [[ -n "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}" ]]; then
              echo "$GENERAL_NOTIF_STATUS_ICON **General Channel** (\`${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}\`): $GENERAL_NOTIF_STATUS"              
            else
              echo "â„¹ï¸ **General Channel:** No Slack channels configured"
            fi
            
            echo ""
          } >> $GITHUB_STEP_SUMMARY