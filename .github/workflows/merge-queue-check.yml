name: Merge Queue Check

run-name: Merge queue check - ${{ inputs.repo_name }}

on:
  workflow_dispatch:
    inputs:
      repo_owner:
        description: 'Repository owner'
        required: true
        type: string
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      head_sha:
        description: 'Head commit SHA to validate'
        required: true
        type: string
      base_branch:
        description: 'Target branch'
        required: true
        type: string

permissions:
  contents: read
  checks: write
  statuses: write

jobs:
  pre-check:
    name: Pre-Check Configuration
    runs-on: ubuntu-latest
    outputs:
      validation_status: ${{ steps.validate.outputs.status }}
      validation_message: ${{ steps.validate.outputs.message }}
      is_update_commit: ${{ steps.validate.outputs.is_update_commit }}
      base_branch: ${{ inputs.base_branch }}
    steps:
      - name: Print Input Parameters
        run: |
          echo "::group::Workflow Inputs"
          echo "repo_owner: ${{ inputs.repo_owner }}"
          echo "repo_name: ${{ inputs.repo_name }}"
          echo "head_sha: ${{ inputs.head_sha }}"
          echo "base_branch: ${{ inputs.base_branch }}"
          echo "::endgroup::"

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          ref: ${{ inputs.head_sha }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 2

      - name: Get Update Configuration
        id: get-config
        uses: folio-org/kitfox-github/.github/actions/get-update-config@master
        with:
          repo: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          branch: master
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Validate Configuration
        id: validate
        env:
          TARGET_BRANCH: ${{ inputs.base_branch }}
          CONFIG_EXISTS: ${{ steps.get-config.outputs.config_exists }}
          ENABLED: ${{ steps.get-config.outputs.enabled }}
          RELEASE_BRANCHES: ${{ steps.get-config.outputs.branches }}
          BRANCH_CONFIG: ${{ steps.get-config.outputs.branch_config }}
        run: |
          echo "::notice::Validating configuration for branch $TARGET_BRANCH"

          if [[ "$CONFIG_EXISTS" != "true" ]]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=Release configuration file not found" >> "$GITHUB_OUTPUT"
            echo "::warning::Configuration file not found: .github/release-config.yml"
            exit 0
          fi

          if [[ "$ENABLED" != "true" ]]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=Release scanning is disabled in configuration" >> "$GITHUB_OUTPUT"
            echo "::notice::Release scanning is disabled"
            exit 0
          fi

          BRANCH_EXISTS=$(echo "$RELEASE_BRANCHES" | jq -r ".[] | select(. == \"$TARGET_BRANCH\")" 2>/dev/null)
          if [ -z "$BRANCH_EXISTS" ]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=Target branch $TARGET_BRANCH is not configured for release scanning" >> "$GITHUB_OUTPUT"
            echo "::notice::Branch $TARGET_BRANCH is not in release_branches configuration"
            exit 0
          fi

          BRANCH_ENTRY=$(echo "$BRANCH_CONFIG" | jq -r ".[] | select(.branch == \"$TARGET_BRANCH\")")
          NEED_PR=$(echo "$BRANCH_ENTRY" | jq -r ".need_pr // false")

          if [[ "$NEED_PR" != "true" ]]; then
            echo "status=skipped" >> "$GITHUB_OUTPUT"
            echo "message=Branch $TARGET_BRANCH is not configured for PR-based updates" >> "$GITHUB_OUTPUT"
            echo "::notice::Branch $TARGET_BRANCH has need_pr=false, skipping check"
            exit 0
          fi

          echo "::notice::Determining if this is an update commit by checking modified files"
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "application.lock.json"; then
            echo "::notice::Commit modifies application.lock.json - this is an update commit"
            echo "is_update_commit=true" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Commit does not modify application.lock.json - this is a non-update commit"
            echo "is_update_commit=false" >> "$GITHUB_OUTPUT"
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "message=Non-update commit in merge queue - validation skipped" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "message=Configuration validation passed" >> "$GITHUB_OUTPUT"
          echo "::notice::Configuration validation successful"


  non-update-check:
    name: Non-Update Check
    needs: pre-check
    if: |
      needs.pre-check.outputs.validation_status == 'success' &&
      needs.pre-check.outputs.is_update_commit == 'false'
    runs-on: ubuntu-latest
    outputs:
      has_violations: ${{ steps.check-protected.outputs.has_violations }}
      violations: ${{ steps.check-protected.outputs.violations }}
    env:
      PROTECTED_LOCK_FILE: application.lock.json
      PROTECTED_TEMPLATE_FILE: application.template.json
      TITLE_TEXT: "${{ inputs.repo_name }} merge queue commit blocked - protected file violation"
      TITLE_BLOCK: |
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*${{ inputs.repo_name }} merge queue commit blocked - protected file violation <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>*"
          }
        }
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          ref: ${{ inputs.head_sha }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 2

      - name: Check Protected Files
        id: check-protected
        run: |
          echo "::notice::Checking protected files for merge queue commit using git diff"
          echo "::notice::Protected files: $PROTECTED_LOCK_FILE (deletion), $PROTECTED_TEMPLATE_FILE (deletion)"
          VIOLATIONS=""

          while IFS=$'\t' read -r STATUS FILE; do
            if [[ "$FILE" == "$PROTECTED_LOCK_FILE" ]] && [[ "$STATUS" == "D" ]]; then
              VIOLATIONS="${VIOLATIONS}${VIOLATIONS:+; }${FILE}: lock file deletion not allowed"
            fi
            if [[ "$FILE" == "$PROTECTED_TEMPLATE_FILE" ]] && [[ "$STATUS" == "D" ]]; then
              VIOLATIONS="${VIOLATIONS}${VIOLATIONS:+; }${FILE}: template file deletion not allowed"
            fi
          done < <(git diff --name-status HEAD~1 HEAD 2>/dev/null || echo "")

          if [ -n "$VIOLATIONS" ]; then
            echo "::error::Protected file violations found: $VIOLATIONS"
            echo "has_violations=true" >> "$GITHUB_OUTPUT"
            echo "violations=$VIOLATIONS" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::No protected file violations found"
            echo "has_violations=false" >> "$GITHUB_OUTPUT"
            echo "violations=" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Check Run
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const hasViolations = '${{ steps.check-protected.outputs.has_violations }}' === 'true';
            const violations = '${{ steps.check-protected.outputs.violations }}';

            const title = hasViolations
              ? 'Protected File Violation'
              : 'Non-Update Commit Approved';

            const summary = hasViolations
              ? `This commit modifies protected files:\n${violations.split('; ').join('\n')}`
              : 'This is not an update commit. Validation skipped, merge can proceed.';

            await github.rest.checks.create({
              owner: '${{ inputs.repo_owner }}',
              repo: '${{ inputs.repo_name }}',
              name: 'eureka-ci / validate-application',
              head_sha: '${{ inputs.head_sha }}',
              status: 'completed',
              conclusion: hasViolations ? 'failure' : 'success',
              completed_at: new Date().toISOString(),
              output: {
                title: title,
                summary: summary
              },
              details_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });

            console.log(`Check run created with conclusion: ${hasViolations ? 'failure' : 'success'}`);

      - name: Get Repository Variables
        id: get-vars
        if: steps.check-protected.outputs.has_violations == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            try {
              const { data: variable } = await github.rest.actions.getRepoVariable({
                owner: '${{ inputs.repo_owner }}',
                repo: '${{ inputs.repo_name }}',
                name: 'SLACK_NOTIF_CHANNEL'
              });
              console.log(`Found SLACK_NOTIF_CHANNEL: ${variable.value}`);
              core.setOutput('team_channel', variable.value);
            } catch (error) {
              console.log(`SLACK_NOTIF_CHANNEL not found or not accessible: ${error.message}`);
              core.setOutput('team_channel', '');
            }

      - name: Build Notification Attachment
        id: build-attachment
        if: steps.check-protected.outputs.has_violations == 'true'
        env:
          VIOLATIONS: ${{ steps.check-protected.outputs.violations }}
        run: |
          ATTACHMENT=$(cat <<EOF
          {
            "color": "danger",
            "fields": [
              {
                "title": "Target Branch",
                "value": "${{ needs.pre-check.outputs.base_branch }}",
                "short": true
              },
              {
                "title": "Commit",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }}|${GITHUB_SHA:0:7}>",
                "short": true
              },
              {
                "title": "Violations",
                "value": "${VIOLATIONS}",
                "short": false
              }
            ],
            "footer": "Eureka CI/CD - Merge Queue"
          }
          EOF
          )
          echo "ATTACHMENT<<EOF" >> "$GITHUB_ENV"
          echo "$ATTACHMENT" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Send Violation Notification to Team Channel
        if: steps.check-protected.outputs.has_violations == 'true' && steps.get-vars.outputs.team_channel != ''
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ steps.get-vars.outputs.team_channel }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ env.ATTACHMENT }}
              ]
            }

      - name: Send Violation Notification to General Channel
        if: steps.check-protected.outputs.has_violations == 'true' && vars.GENERAL_SLACK_NOTIF_CHANNEL != ''
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ env.ATTACHMENT }}
              ]
            }


  check:
    name: Check commit
    needs: pre-check
    if: |
      needs.pre-check.outputs.validation_status == 'success' &&
      needs.pre-check.outputs.is_update_commit == 'true'
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.check-commit.outputs.validation_passed }}
      failure_reason: ${{ steps.check-commit.outputs.failure_reason }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          ref: ${{ inputs.head_sha }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 2

      - name: Check Commit
        id: check-commit
        uses: folio-org/kitfox-github/.github/actions/check-commit@master
        with:
          repo_owner: ${{ inputs.repo_owner }}
          repo_name: ${{ inputs.repo_name }}
          head_sha: ${{ inputs.head_sha }}
          base_branch: ${{ inputs.base_branch }}
          github_token: ${{ steps.app-token.outputs.token }}
          check_type: merge_queue
          far_url: ${{ vars.FAR_URL }}
          workflow_run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}


  notify:
    name: Send Notifications
    needs: [pre-check, check]
    if: |
      always() && !cancelled() &&
      needs.pre-check.outputs.validation_status == 'success' &&
      needs.pre-check.outputs.is_update_commit == 'true'
    runs-on: ubuntu-latest
    outputs:
      team_channel: ${{ steps.get-vars.outputs.team_channel }}
    env:
      TITLE_TEXT: "${{ inputs.repo_name }} merge queue check ${{ (needs.check.result == 'success' && needs.check.outputs.validation_passed == 'true') && 'passed' || 'failed' }}"
      TITLE_BLOCK: |
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*${{ inputs.repo_name }} merge queue check ${{ (needs.check.result == 'success' && needs.check.outputs.validation_passed == 'true') && 'passed' || 'failed' }} <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>*"
          }
        }
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Get Repository Variables
        id: get-vars
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            try {
              const { data: variable } = await github.rest.actions.getRepoVariable({
                owner: '${{ inputs.repo_owner }}',
                repo: '${{ inputs.repo_name }}',
                name: 'SLACK_NOTIF_CHANNEL'
              });
              console.log(`Found SLACK_NOTIF_CHANNEL: ${variable.value}`);
              core.setOutput('team_channel', variable.value);
            } catch (error) {
              console.log(`SLACK_NOTIF_CHANNEL not found or not accessible: ${error.message}`);
              core.setOutput('team_channel', '');
            }

      - name: Build Notification Attachment
        id: build-attachment
        env:
          BASE_BRANCH: ${{ needs.pre-check.outputs.base_branch }}
          FAILURE_REASON: ${{ needs.check.outputs.failure_reason }}
        run: |
          ATTACHMENT=$(cat <<EOF
          {
            "color": "${{ (needs.check.result == 'success' && needs.check.outputs.validation_passed == 'true') && 'good' || 'danger' }}",
            "fields": [
              {
                "title": "Target branch",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/tree/${BASE_BRANCH}|${BASE_BRANCH}>",
                "short": true
              },
              {
                "title": "Commit",
                "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }}|${{ inputs.head_sha }}>",
                "short": true
              }${{ (needs.check.result != 'success' || needs.check.outputs.validation_passed != 'true') && format(',
              {{
                "title": "Failure Reason",
                "value": "{0}",
                "short": false
              }}', needs.check.outputs.failure_reason) || '' }}
            ],
            "footer": "Eureka CI/CD - Merge Queue"
          }
          EOF
          )
          echo "ATTACHMENT<<EOF" >> "$GITHUB_ENV"
          echo "$ATTACHMENT" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Send to Team Channel
        if: steps.get-vars.outputs.team_channel != ''
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ steps.get-vars.outputs.team_channel }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ env.ATTACHMENT }}
              ]
            }

      - name: Send to General Channel
        if: vars.GENERAL_SLACK_NOTIF_CHANNEL != ''
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ env.ATTACHMENT }}
              ]
            }


  summarize:
    name: Workflow Summary
    needs: [pre-check, check, notify]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Workflow Summary
        env:
          PRE_CHECK_RESULT: ${{ needs.pre-check.result }}
          VALIDATION_STATUS: ${{ needs.pre-check.outputs.validation_status }}
          VALIDATION_MESSAGE: ${{ needs.pre-check.outputs.validation_message }}
          CHECK_RESULT: ${{ needs.check.result }}
          VALIDATION_PASSED: ${{ needs.check.outputs.validation_passed }}
          FAILURE_REASON: ${{ needs.check.outputs.failure_reason }}
          BASE_BRANCH: ${{ needs.pre-check.outputs.base_branch }}
        run: |
          {
            echo "### Merge Queue Check Summary"
            echo ""
            echo "**Repository:** \`${{ inputs.repo_owner }}/${{ inputs.repo_name }}\`"
            echo "**Target Branch:** \`$BASE_BRANCH\`"
            echo "**Commit:** [\`${{ inputs.head_sha }}\`](https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }})"
            echo ""

            echo "### Pre-Check Status"
            echo ""
            if [[ "$PRE_CHECK_RESULT" == "success" ]]; then
              if [[ "$VALIDATION_STATUS" == "success" ]]; then
                echo "**Pre-Check:** Passed"
                echo "- **Message:** $VALIDATION_MESSAGE"
              elif [[ "$VALIDATION_STATUS" == "skipped" ]]; then
                echo "**Pre-Check:** Skipped"
                echo "- **Reason:** $VALIDATION_MESSAGE"
              else
                echo "**Pre-Check:** Unknown status ($VALIDATION_STATUS)"
              fi
            elif [[ "$PRE_CHECK_RESULT" == "failure" ]]; then
              echo "**Pre-Check:** Failed"
              echo "- **Message:** $VALIDATION_MESSAGE"
            elif [[ "$PRE_CHECK_RESULT" == "cancelled" ]]; then
              echo "**Pre-Check:** Cancelled"
            else
              echo "**Pre-Check:** Skipped"
            fi

            echo ""
            echo "### Application Check Status"
            echo ""

            if [[ "$VALIDATION_STATUS" != "success" ]]; then
              echo "Application check was skipped due to pre-check status"
            elif [[ "$CHECK_RESULT" == "success" ]]; then
              if [[ "$VALIDATION_PASSED" == "true" ]]; then
                echo "**Application Check:** Passed"
              else
                echo "**Application Check:** Failed"
                if [[ -n "$FAILURE_REASON" ]]; then
                  echo "- **Failure Reason:** $FAILURE_REASON"
                fi
              fi
            elif [[ "$CHECK_RESULT" == "failure" ]]; then
              echo "**Application Check:** Failed"
              if [[ -n "$FAILURE_REASON" ]]; then
                echo "- **Failure Reason:** $FAILURE_REASON"
              else
                echo "- Check the workflow logs for details"
              fi
            elif [[ "$CHECK_RESULT" == "cancelled" ]]; then
              echo "**Application Check:** Cancelled"
            else
              echo "**Application Check:** Skipped"
            fi

            echo ""
            echo "### Notification Status"
            echo ""

            if [[ -n "${{ needs.notify.outputs.team_channel }}" ]]; then
              if [[ "${{ needs.notify.result }}" == "success" ]]; then
                echo "**Team Channel** (\`${{ needs.notify.outputs.team_channel }}\`): Sent"
              elif [[ "${{ needs.notify.result }}" == "failure" ]]; then
                echo "**Team Channel** (\`${{ needs.notify.outputs.team_channel }}\`): Failed"
              else
                echo "**Team Channel** (\`${{ needs.notify.outputs.team_channel }}\`): Skipped"
              fi
            else
              echo "**Team Channel:** Not configured"
            fi

            echo ""

            if [[ -n "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}" ]]; then
              if [[ "${{ needs.notify.result }}" == "success" ]]; then
                echo "**General Channel** (\`${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}\`): Sent"
              elif [[ "${{ needs.notify.result }}" == "failure" ]]; then
                echo "**General Channel** (\`${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}\`): Failed"
              else
                echo "**General Channel** (\`${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}\`): Skipped"
              fi
            else
              echo "**General Channel:** Not configured"
            fi

            echo ""
            echo "---"
            echo ""
            echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> $GITHUB_STEP_SUMMARY