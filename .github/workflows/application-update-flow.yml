name: Application update (Flow)

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name'
        required: true
        type: string
      repo:
        description: 'Application repository name (org/repo format)'
        required: true
        type: string
      branch:
        description: 'Primary branch to update (e.g., snapshot or release branch)'
        required: true
        type: string
      update_branch:
        description: 'Optional update branch (used when need_pr = true)'
        required: false
        type: string
        default: ''
      need_pr:
        description: 'Whether the update should be performed through a PR'
        required: false
        type: boolean
        default: false
      workflow_run_number:
        description: 'GitHub run number for display'
        required: true
        type: string
      descriptor_build_offset:
        description: 'Offset to apply to application artifact version (snapshot only)'
        required: false
        type: string
        default: ''
      rely_on_FAR:
        description: 'Whether to rely on FAR for application descriptor dependencies'
        required: false
        type: boolean
        default: false
      pre_release:
        description: 'Pre-release mode (true = snapshot and release, only = snapshot-only, false = release only)'
        required: false
        type: string
        default: 'false'
      dry_run:
        description: 'Perform dry run without making changes'
        required: false
        type: boolean
        default: false
      use_github_app:
        description: 'Use GitHub App for authentication'
        required: false
        type: boolean
        default: false
      pr_reviewers:
        description: 'Comma-separated list of reviewers (users or teams with org/ prefix)'
        required: false
        type: string
        default: ''
      pr_labels:
        description: 'Comma-separated list of labels to add to PR'
        required: false
        type: string
        default: ''
    outputs:
      updated:
        description: 'Whether the application was updated'
        value: ${{ jobs.update-application.outputs.updated || 'false' }}
      updated_modules:
        description: 'List of updated modules'
        value: ${{ jobs.update-application.outputs.updated_modules }}
      updated_cnt:
        description: 'Number of updated modules'
        value: ${{ jobs.update-application.outputs.updates_cnt }}
      previous_version:
        description: 'Previous application version'
        value: ${{ jobs.update-application.outputs.previous_version }}
      new_version:
        description: 'New application version'
        value: ${{ jobs.update-application.outputs.new_version }}
      commit_sha:
        description: 'Commit SHA created by the update (if any)'
        value: ${{ jobs.commit-changes.outputs.commit_sha }}
      pr_created:
        description: 'Whether a PR was created'
        value: ${{ jobs.manage-pr.outputs.pr_created }}
      pr_updated:
        description: 'Whether an existing PR was updated'
        value: ${{ jobs.manage-pr.outputs.pr_updated }}
      pr_number:
        description: 'Number of the created or updated PR'
        value: ${{ jobs.manage-pr.outputs.pr_number }}
      pr_url:
        description: 'URL of the created or updated PR'
        value: ${{ jobs.manage-pr.outputs.pr_url }}
      successful_reviewers:
        description: 'Successfully added reviewers'
        value: ${{ jobs.manage-pr.outputs.successful_reviewers }}
      failed_reviewers:
        description: 'Failed reviewers'
        value: ${{ jobs.manage-pr.outputs.failed_reviewers }}
      app_descriptor_url:
        description: 'URL of generated application descriptor (snapshot flow)'
        value: ${{ jobs.update-application.outputs.app_descriptor_file_name != '' && format('{0}/applications/{1}?full=true', vars.FAR_URL, jobs.update-application.outputs.app_descriptor_file_name) || '' }}
      app_descriptor_file_name:
        description: 'Name of generated application descriptor file'
        value: ${{ jobs.update-application.outputs.app_descriptor_file_name }}
      workflow_status:
        description: 'Overall workflow status'
        value: ${{ 
          jobs.update-application.result == 'failure' && 'failure' || 
          (jobs.verify-application.result == 'failure' && 'failure' || 
          (jobs.commit-changes.result == 'failure' && 'failure' || 
          (jobs.manage-pr.result == 'failure' && 'failure' ||
          'success'))) 
          }}
      failure_reason:
        description: 'Reason for workflow failure if any'
        value: ${{
          (jobs.update-application.outputs.failure_reason != '' && jobs.update-application.outputs.failure_reason) ||
          (jobs.verify-application.outputs.failure_reason != '' && jobs.verify-application.outputs.failure_reason) ||
          (jobs.commit-changes.outputs.failure_reason != '' && jobs.commit-changes.outputs.failure_reason) ||
          '' }}

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  APP_NAME: ${{ inputs.app_name }}
  GH_TOKEN: ${{ github.token }}
  FAR_API_URL: "https://far.ci.folio.org/applications"

jobs:
  prepare-context:
    name: Prepare Update Context
    runs-on: ubuntu-latest
    outputs:
      target_branch: ${{ steps.determine.outputs.target_branch }}
      need_pr: ${{ steps.determine.outputs.need_pr }}
      base_branch: ${{ steps.determine.outputs.base_branch }}
      update_branch_exists: ${{ steps.determine.outputs.update_branch_exists }}
      pr_exists: ${{ steps.check-pr.outputs.pr_exists }}
      pr_number: ${{ steps.check-pr.outputs.pr_number }}
      pr_url: ${{ steps.check-pr.outputs.pr_url }}
    steps:
      - name: Determine target branch
        id: determine
        env:
          REPO: ${{ inputs.repo }}
          BASE_BRANCH: ${{ inputs.branch }}
          UPDATE_BRANCH: ${{ inputs.update_branch }}
          NEED_PR_INPUT: ${{ inputs.need_pr }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail

          normalize_bool() {
            local value="${1,,}"
            [[ "$value" == "true" || "$value" == "1" || "$value" == "yes" ]] && echo "true" || echo "false"
          }

          need_pr=$(normalize_bool "$NEED_PR_INPUT")
          update_branch="${UPDATE_BRANCH}"
          base_branch="${BASE_BRANCH}"
          target_branch="$base_branch"
          update_branch_exists="false"

          if [[ "$need_pr" == "true" && -n "$update_branch" ]]; then
            if gh api "repos/$REPO/branches/$update_branch" >/dev/null 2>&1; then
              echo "::notice::Update branch exists: $update_branch"
              target_branch="$update_branch"
              update_branch_exists="true"
            else
              echo "::notice::Update branch $update_branch not found, will operate on $base_branch and create branch on commit"
            fi
          else
            need_pr="false"
            update_branch=""
          fi

          {
            echo "target_branch=$target_branch"
            echo "need_pr=$need_pr"
            echo "base_branch=$base_branch"
            echo "update_branch_exists=$update_branch_exists"
          } >> "$GITHUB_OUTPUT"

      - name: Check for existing PR
        id: check-pr
        if: steps.determine.outputs.need_pr == 'true' && steps.determine.outputs.update_branch_exists == 'true'
        env:
          REPO: ${{ inputs.repo }}
          BASE_BRANCH: ${{ inputs.branch }}
          HEAD_BRANCH: ${{ inputs.update_branch }}
        run: |
          set -eo pipefail

          echo "::notice::Checking for existing PR from $HEAD_BRANCH to $BASE_BRANCH"

          pr_json=$(gh pr list \
            --repo "$REPO" \
            --base "$BASE_BRANCH" \
            --head "$HEAD_BRANCH" \
            --json number,url \
            --jq '.[0]' || echo '{}')

          if [ "$pr_json" != "{}" ] && [ -n "$pr_json" ] && [ "$(echo "$pr_json" | jq -r '.url // ""')" != "" ]; then
            pr_number=$(echo "$pr_json" | jq -r '.number // ""')
            pr_url=$(echo "$pr_json" | jq -r '.url // ""')
            echo "::notice::Found existing PR #$pr_number: $pr_url"
            echo "pr_exists=true" >> "$GITHUB_OUTPUT"
            echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
            echo "pr_url=$pr_url" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::No existing PR found"
            echo "pr_exists=false" >> "$GITHUB_OUTPUT"
            echo "pr_number=" >> "$GITHUB_OUTPUT"
            echo "pr_url=" >> "$GITHUB_OUTPUT"
          fi

  update-application:
    name: Update Application
    needs: prepare-context
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.generate.outputs.generated }}
      updates_cnt: ${{ steps.generate.outputs.updates_cnt }}
      updated_modules: ${{ steps.generate.outputs.updated_modules }}
      previous_version: ${{ steps.collect-previous-version.outputs.version }}
      new_version: ${{ steps.collect-new-version.outputs.version }}
      app_descriptor_file: ${{ steps.generate.outputs.descriptor_file }}
      app_descriptor_file_name: ${{ steps.generate.outputs.descriptor_file_name }}
      artifact_name: ${{ steps.generate.outputs.artifact_name }}
      state_file_artifact_name: ${{ steps.generate.outputs.state_file_artifact_name }}
      failure_reason: ${{ steps.generate.outputs.failure_reason || '' }}
    steps:
      - name: Checkout Application Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo }}
          ref: ${{ needs.prepare-context.outputs.target_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Template from Base Branch
        if: |
          needs.prepare-context.outputs.need_pr == 'true' &&
          needs.prepare-context.outputs.update_branch_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_BRANCH: ${{ inputs.branch }}
          REPO: ${{ inputs.repo }}
        run: |
          set -eo pipefail

          echo "::notice::Fetching template from base branch: $BASE_BRANCH"

          gh api "repos/$REPO/contents/application.template.json?ref=$BASE_BRANCH" \
            --jq '.content' | base64 -d > application.template.json

          echo "::notice::Template file sourced from base branch"

      - name: Collect Previous Version
        id: collect-previous-version
        run: |
          if [[ -f "application.lock.json" ]]; then
            version=$(jq -r '.version' application.lock.json)
          else
            version=$(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Calculate Build Number
        id: build-number
        env:
          OFFSET: ${{ inputs.descriptor_build_offset }}
          RUN_NUMBER: ${{ inputs.workflow_run_number }}
        run: |
          if [[ -n "$OFFSET" ]]; then
            echo "value=$((OFFSET + RUN_NUMBER))" >> "$GITHUB_OUTPUT"
          else
            echo "value=$RUN_NUMBER" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate Descriptor
        id: generate
        uses: folio-org/kitfox-github/.github/actions/generate-application-descriptor@master
        with:
          app_name: ${{ inputs.app_name }}
          build_number: ${{ steps.build-number.outputs.value }}
          use_input_generator_version: true #TODO: remove sometime later

      - name: Collect New Version
        id: collect-new-version
        if: steps.generate.outputs.generated == 'true'
        run: echo "version=$(jq -r '.version' target/${{ steps.generate.outputs.descriptor_file }})" >> "$GITHUB_OUTPUT"

  verify-application:
    name: Verify Application
    needs: update-application
    if: needs.update-application.outputs.updated == 'true' && needs.prepare-context.outputs.need_pr != 'true'
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validate.outputs.validation_passed }}
      failure_reason: ${{ steps.validate.outputs.failure_reason }}
      publish_status: ${{ steps.publish.outputs.publish-status }}
    steps:
      - name: Fetch Platform Descriptor
        id: fetch-platform
        if: ${{ !inputs.rely_on_FAR }}
        uses: folio-org/kitfox-github/.github/actions/fetch-platform-descriptor@master
        with:
          branch: ${{ inputs.branch }}
          upload_artifact: 'false'

      - name: Validate Application
        id: validate
        uses: folio-org/kitfox-github/.github/actions/validate-application@master
        with:
          app_name: ${{ inputs.app_name }}
          app_descriptor_artifact_file_name: ${{ needs.update-application.outputs.app_descriptor_file }}
          app_descriptor_artifact_name: ${{ needs.update-application.outputs.artifact_name }}
          platform_descriptor_path: ${{ steps.fetch-platform.outputs.descriptor_path }}
          rely_on_FAR: ${{ inputs.rely_on_FAR }}
          far_url: ${{ vars.FAR_URL }}

      - name: Publish Application Descriptor
        id: publish
        if: inputs.dry_run != true
        uses: folio-org/kitfox-github/.github/actions/publish-app-descriptor@master
        with:
          descriptor-artifact-name: ${{ needs.update-application.outputs.artifact_name }}
          descriptor-file-name: ${{ needs.update-application.outputs.app_descriptor_file }}
          far-url: ${{ vars.FAR_URL }}

  commit-changes:
    name: Commit Changes
    needs: [prepare-context, update-application, verify-application]
    if: |
      always() &&
      !cancelled() &&
      needs.update-application.outputs.updated == 'true' &&
      (needs.prepare-context.outputs.need_pr == 'true' || needs.verify-application.result == 'success')
    uses: ./.github/workflows/commit-and-push-changes.yml
    with:
      repo: ${{ inputs.repo }}
      branch: ${{ needs.prepare-context.outputs.need_pr == 'true' && inputs.update_branch || inputs.branch }}
      artifact_name: ${{ needs.update-application.outputs.state_file_artifact_name }}
      commit_message: |
        Update modules to ${{ needs.update-application.outputs.new_version }}.

        Updated modules:
        ${{ needs.update-application.outputs.updated_modules }}
      dry_run: ${{ inputs.dry_run }}
      use_github_app: ${{ inputs.use_github_app }}
      source_branch: ${{ needs.prepare-context.outputs.target_branch }}
    secrets: inherit

  manage-pr:
    name: Manage Pull Request
    needs: [prepare-context, update-application, commit-changes]
    if: |
      always() &&
      !inputs.dry_run &&
      !cancelled() &&
      needs.prepare-context.outputs.need_pr == 'true' &&
      needs.update-application.result == 'success' &&
      (
        needs.update-application.outputs.updated == 'true' ||
        needs.prepare-context.outputs.update_branch_exists == 'true'
      )
    runs-on: ubuntu-latest
    outputs:
      pr_created: ${{ steps.create-pr.outputs.pr_created == 'true' }}
      pr_updated: ${{ steps.update-pr.outputs.pr_updated == 'true' }}
      pr_number: ${{ steps.create-pr.outputs.pr_number || steps.update-pr.outputs.pr_number || needs.prepare-context.outputs.pr_number || '' }}
      pr_url: ${{ steps.create-pr.outputs.pr_url || steps.update-pr.outputs.pr_url || needs.prepare-context.outputs.pr_url || '' }}
      successful_reviewers: ${{ steps.create-pr.outputs.successful_reviewers || steps.update-pr.outputs.successful_reviewers || '' }}
      failed_reviewers: ${{ steps.create-pr.outputs.failed_reviewers || steps.update-pr.outputs.failed_reviewers || '' }}
    steps:
      - name: Compare Application Versions
        id: compare
        uses: folio-org/kitfox-github/.github/actions/compare-state-files@master
        with:
          repo: ${{ inputs.repo }}
          base-source-type: 'branch'
          base-source: ${{ inputs.branch }}
          head-source-type: 'branch'
          head-source: ${{ inputs.update_branch }}
          github-token: ${{ github.token }}

      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ inputs.app_name }}

      - name: Create PR if needed
        id: create-pr
        if: |
          needs.prepare-context.outputs.pr_exists != 'true' &&
          (needs.update-application.outputs.updated == 'true' ||
           needs.prepare-context.outputs.update_branch_exists == 'true')
        uses: folio-org/kitfox-github/.github/actions/create-pr@master
        with:
          repo: ${{ inputs.repo }}
          base_branch: ${{ inputs.branch }}
          head_branch: ${{ inputs.update_branch }}
          pr_title: "Release: Update to ${{ steps.compare.outputs.new-version || 'No updates' }}"
          pr_body: |
            ## Automated Module Updates

            **New Version:** ${{ steps.compare.outputs.new-version || 'No version change' }}
            **Total modules updated:** ${{ steps.compare.outputs.updates-cnt || '0' }}

            ### Updated Modules:
            ```
            ${{ steps.compare.outputs.updated-modules || 'No modules updated' }}
            ```

            This PR was automatically generated by the update workflow.
          pr_labels: ${{ inputs.pr_labels }}
          pr_reviewers: ${{ inputs.pr_reviewers }}
          github_token: ${{ steps.app-token.outputs.token || github.token }}

      - name: Update existing PR if needed
        id: update-pr
        if: |
          needs.prepare-context.outputs.pr_exists == 'true' &&
          needs.update-application.outputs.updated == 'true'
        uses: folio-org/kitfox-github/.github/actions/update-pr@master
        with:
          repo: ${{ inputs.repo }}
          pr_number: ${{ needs.prepare-context.outputs.pr_number }}
          pr_title: "Release: Update to ${{ steps.compare.outputs.new-version }}"
          pr_body: |
            ## Automated Module Updates

            **New Version:** ${{ steps.compare.outputs.new-version }}
            **Total modules updated:** ${{ steps.compare.outputs.updates-cnt }}

            ### Updated Modules:
            ```
            ${{ steps.compare.outputs.updated-modules }}
            ```

            This PR was automatically generated by the update workflow.
          pr_labels: ${{ inputs.pr_labels }}
          pr_reviewers: ${{ inputs.pr_reviewers }}
          github_token: ${{ steps.app-token.outputs.token || github.token }}

  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    needs: [update-application, verify-application, commit-changes]
    if: >
      failure() &&
      inputs.dry_run != true &&
      needs.verify-application.result == 'success' &&
      needs.verify-application.outputs.publish_status == 'success' &&
      needs.update-application.outputs.app_descriptor_file_name != ''
    steps:
      - name: Unpublish Application Descriptor
        uses: folio-org/kitfox-github/.github/actions/unpublish-app-descriptor@master
        with:
          descriptor-id: ${{ needs.update-application.outputs.app_descriptor_file_name }}
          far-url: ${{ vars.FAR_URL }}

  upload-results:
    name: Upload Results
    runs-on: ubuntu-latest
    needs:
      - prepare-context
      - update-application
      - verify-application
      - commit-changes
      - cleanup-on-failure
      - manage-pr
    if: always()
    steps:
      - name: Prepare Output Artifact
        id: prepare-artifact
        env:
          APPLICATION: ${{ inputs.app_name }}
          REPO: ${{ inputs.repo }}
          BASE_BRANCH: ${{ inputs.branch }}
          TARGET_BRANCH: ${{ needs.prepare-context.outputs.target_branch }}
          UPDATE_BRANCH: ${{ inputs.update_branch }}
          NEED_PR: ${{ needs.prepare-context.outputs.need_pr || 'false' }}
          WORKFLOW_STATUS: >-
            ${{
              (needs.update-application.result == 'failure' && 'failure') ||
              (needs.verify-application.result == 'failure' && 'failure') ||
              (needs.commit-changes.result == 'failure' && 'failure') ||
              (needs.manage-pr.result == 'failure' && 'failure') ||
              'success'
            }}
          FAILURE_REASON: >-
            ${{
              needs.update-application.outputs.failure_reason ||
              needs.verify-application.outputs.failure_reason ||
              needs.commit-changes.outputs.failure_reason ||
              ''
            }}
          UPDATED: ${{ needs.update-application.outputs.updated || 'false' }}
          UPDATED_CNT: ${{ needs.update-application.outputs.updates_cnt || '0' }}
          UPDATED_MODULES: ${{ needs.update-application.outputs.updated_modules }}
          PREVIOUS_VERSION: ${{ needs.update-application.outputs.previous_version }}
          NEW_VERSION: ${{ needs.update-application.outputs.new_version }}
          COMMIT_SHA: ${{ needs.commit-changes.outputs.commit_sha || '' }}
          PR_CREATED: ${{ needs.manage-pr.outputs.pr_created || 'false' }}
          PR_URL: ${{ needs.manage-pr.outputs.pr_url || '' }}
          PR_NUMBER: ${{ needs.manage-pr.outputs.pr_number || '' }}
        run: |
          set -eo pipefail

          results_dir="/tmp/results"
          mkdir -p "$results_dir"

          printf '%s' "$UPDATED_MODULES" > "$results_dir/updated_modules.txt"
          printf '%s' "$FAILURE_REASON" > "$results_dir/failure_reason.txt"

          sanitized_branch=$(printf '%s' "$BASE_BRANCH" | tr '/ ' '--')
          result_file="$results_dir/${APPLICATION}_${sanitized_branch}.json"

          jq -n \
            --arg application "$APPLICATION" \
            --arg repo "$REPO" \
            --arg base_branch "$BASE_BRANCH" \
            --arg target_branch "$TARGET_BRANCH" \
            --arg update_branch "$UPDATE_BRANCH" \
            --arg workflow_status "$WORKFLOW_STATUS" \
            --rawfile updated_modules "$results_dir/updated_modules.txt" \
            --rawfile failure_reason "$results_dir/failure_reason.txt" \
            --arg commit_sha "$COMMIT_SHA" \
            --arg pr_url "$PR_URL" \
            --arg pr_number "$PR_NUMBER" \
            --arg need_pr "$NEED_PR" \
            --arg previous_version "$PREVIOUS_VERSION" \
            --arg new_version "$NEW_VERSION" \
            --argjson updated "$([[ "$UPDATED" == "true" ]] && echo true || echo false)" \
            --argjson updated_cnt "${UPDATED_CNT:-0}" \
            --argjson pr_created "$([[ "$PR_CREATED" == "true" ]] && echo true || echo false)" \
            '{
              application: $application,
              repo: $repo,
              base_branch: $base_branch,
              target_branch: $target_branch,
              update_branch: $update_branch,
              need_pr: ($need_pr == "true"),
              workflow_status: $workflow_status,
              status: $workflow_status,
              updated: $updated,
              updates_cnt: $updated_cnt,
              updated_modules: $updated_modules,
              previous_version: $previous_version,
              new_version: $new_version,
              failure_reason: $failure_reason,
              commit_sha: $commit_sha,
              pr_created: $pr_created,
              pr_url: $pr_url,
              pr_number: $pr_number
            }' > "$result_file"

          echo "::group::Application update result"
          cat "$result_file"
          echo "::endgroup::"

          echo "result_file=$result_file" >> "$GITHUB_OUTPUT"
          echo "artifact_name=result-${APPLICATION}-${sanitized_branch}" >> "$GITHUB_OUTPUT"

      - name: Upload Result Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prepare-artifact.outputs.artifact_name }}
          path: ${{ steps.prepare-artifact.outputs.result_file }}
          retention-days: 1
