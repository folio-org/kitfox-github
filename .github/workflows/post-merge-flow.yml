name: Post-Merge Flow

run-name: >-
  Post-merge • PR #${{ inputs.pr_number }} • ${{ inputs.repo_name }}

on:
  workflow_dispatch:
    inputs:
      repo_owner:
        description: 'Repository owner'
        required: true
        type: string
      repo_name:
        description: 'Repository name'
        required: true
        type: string
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      head_sha:
        description: 'Head commit SHA that was merged'
        required: true
        type: string
      base_branch:
        description: 'Base branch the PR was merged into'
        required: false
        type: string
        default: ''
      merged:
        description: 'Whether the PR was merged (true/false)'
        required: false
        type: string
        default: 'false'

permissions:
  contents: read

jobs:
  pre-check:
    name: Pre-Check Merge Status
    runs-on: ubuntu-latest
    outputs:
      should_process: ${{ steps.validate-config.outputs.should_process || steps.check-merge.outputs.should_process }}
      skip_reason: ${{ steps.validate-config.outputs.skip_reason || steps.check-merge.outputs.skip_reason }}
      base_branch: ${{ steps.pr-info.outputs.base_ref || inputs.base_branch }}
      head_branch: ${{ steps.pr-info.outputs.head_ref }}
    steps:
      - name: Check Merge Status
        id: check-merge
        run: |
          if [[ "${{ inputs.merged }}" != "true" ]]; then
            echo "should_process=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=PR was closed but not merged" >> "$GITHUB_OUTPUT"
            echo "::notice::PR #${{ inputs.pr_number }} was closed without merging, skipping"
            exit 0
          fi
          echo "should_process=true" >> "$GITHUB_OUTPUT"
          echo "::notice::PR #${{ inputs.pr_number }} was merged, proceeding with post-merge processing"

      - name: Generate GitHub App Token
        id: app-token
        if: steps.check-merge.outputs.should_process == 'true'
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Get Pull Request Information
        id: pr-info
        if: steps.check-merge.outputs.should_process == 'true'
        uses: folio-org/kitfox-github/.github/actions/get-pr-info@master
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          pr_number: ${{ inputs.pr_number }}
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Get Update Configuration
        id: get-config
        if: steps.check-merge.outputs.should_process == 'true'
        uses: folio-org/kitfox-github/.github/actions/get-update-config@master
        with:
          repo: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          branch: master
          github_token: ${{ steps.app-token.outputs.token }}

      - name: Validate Configuration
        id: validate-config
        if: steps.check-merge.outputs.should_process == 'true'
        env:
          TARGET_BRANCH: ${{ steps.pr-info.outputs.base_ref || inputs.base_branch }}
          CONFIG_EXISTS: ${{ steps.get-config.outputs.config_exists }}
          ENABLED: ${{ steps.get-config.outputs.enabled }}
          RELEASE_BRANCHES: ${{ steps.get-config.outputs.branches }}
        run: |
          if [[ "$CONFIG_EXISTS" != "true" ]]; then
            echo "should_process=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=Release configuration file not found" >> "$GITHUB_OUTPUT"
            echo "::warning::Configuration file not found: .github/update-config.yml"
            exit 0
          fi

          if [[ "$ENABLED" != "true" ]]; then
            echo "should_process=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=Release scanning is disabled in configuration" >> "$GITHUB_OUTPUT"
            echo "::notice::Release scanning is disabled"
            exit 0
          fi

          BRANCH_EXISTS=$(echo "$RELEASE_BRANCHES" | jq -r ".[] | select(. == \"$TARGET_BRANCH\")" 2>/dev/null)
          if [ -z "$BRANCH_EXISTS" ]; then
            echo "should_process=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=Target branch $TARGET_BRANCH is not configured for release scanning" >> "$GITHUB_OUTPUT"
            echo "::notice::Branch $TARGET_BRANCH is not in release_branches configuration"
            exit 0
          fi

          echo "should_process=true" >> "$GITHUB_OUTPUT"
          echo "::notice::Configuration validation successful for branch $TARGET_BRANCH"


  publish:
    name: Publish to FAR
    needs: pre-check
    if: needs.pre-check.outputs.should_process == 'true'
    runs-on: ubuntu-latest
    outputs:
      publish_status: ${{ steps.publish.outputs.publish-status }}
      descriptor_url: ${{ steps.publish.outputs.descriptor-url }}
      descriptor_id: ${{ steps.get-descriptor-id.outputs.descriptor_id }}
      descriptor_exists: ${{ steps.check-descriptor.outputs.exists }}
      failure_reason: ${{ steps.check-descriptor.outputs.failure_reason || steps.publish.outputs.failure-reason }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          ref: ${{ needs.pre-check.outputs.base_branch }}
          token: ${{ steps.app-token.outputs.token }}

      - name: Check Existing Descriptor
        id: check-descriptor
        env:
          DESCRIPTOR_FILE: "application.lock.json"
        run: |
          set -eo pipefail

          if [[ ! -f "$DESCRIPTOR_FILE" ]]; then
            echo "::error::Application descriptor not found after merge: $DESCRIPTOR_FILE"
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "failure_reason=Application descriptor file not found: $DESCRIPTOR_FILE" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::notice::Found application descriptor: $DESCRIPTOR_FILE"
          echo "exists=true" >> "$GITHUB_OUTPUT"

      - name: Get Descriptor ID
        id: get-descriptor-id
        if: steps.check-descriptor.outputs.exists == 'true'
        run: |
          DESCRIPTOR_ID=$(jq -r '.id' application.lock.json)
          echo "descriptor_id=$DESCRIPTOR_ID" >> "$GITHUB_OUTPUT"
          echo "::notice::Descriptor ID: $DESCRIPTOR_ID"

      - name: Publish Application Descriptor to FAR
        id: publish
        if: steps.check-descriptor.outputs.exists == 'true'
        uses: folio-org/kitfox-github/.github/actions/publish-app-descriptor@master
        with:
          descriptor-path: application.lock.json
          far-url: ${{ vars.FAR_URL }}


  cleanup-branch:
    name: Cleanup Update Branch
    needs: [pre-check, publish]
    if: always() && !cancelled() && needs.pre-check.outputs.should_process == 'true'
    runs-on: ubuntu-latest
    outputs:
      branch_deleted: ${{ steps.delete-branch.outputs.deleted }}
      failure_reason: ${{ steps.delete-branch.outputs.failure_reason }}
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Delete Update Branch
        id: delete-branch
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          HEAD_BRANCH: ${{ needs.pre-check.outputs.head_branch }}
        run: |
          if [[ -z "$HEAD_BRANCH" ]]; then
            echo "::notice::No head branch info available, skipping cleanup"
            echo "deleted=skipped" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$HEAD_BRANCH" != update-* ]]; then
            echo "::notice::Branch '$HEAD_BRANCH' is not an update branch, skipping cleanup"
            echo "deleted=skipped" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::notice::Deleting merged update branch: $HEAD_BRANCH"
          if gh api -X DELETE "repos/$REPO/git/refs/heads/$HEAD_BRANCH" 2>/dev/null; then
            echo "::notice::Branch '$HEAD_BRANCH' deleted successfully"
            echo "deleted=true" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::Failed to delete branch '$HEAD_BRANCH'"
            echo "deleted=false" >> "$GITHUB_OUTPUT"
            echo "failure_reason=Failed to delete update branch: $HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          fi

  notify:
    name: Send Notifications
    needs: [pre-check, publish, cleanup-branch]
    if: always() && !cancelled() && needs.pre-check.outputs.should_process == 'true'
    runs-on: ubuntu-latest
    outputs:
      team_channel: ${{ steps.get-vars.outputs.team_channel }}
    env:
      WORKFLOW_SUCCESS: ${{ needs.publish.outputs.descriptor_exists == 'true' && needs.publish.outputs.publish_status == 'success' && needs.cleanup-branch.outputs.deleted != 'false' }}
      TITLE_TEXT: "${{ inputs.repo_name }} post-merge ${{ (needs.publish.outputs.descriptor_exists == 'true' && needs.publish.outputs.publish_status == 'success' && needs.cleanup-branch.outputs.deleted != 'false') && 'completed' || 'failed' }}"
      TITLE_BLOCK: |
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*${{ inputs.repo_name }} post-merge ${{ (needs.publish.outputs.descriptor_exists == 'true' && needs.publish.outputs.publish_status == 'success' && needs.cleanup-branch.outputs.deleted != 'false') && 'completed' || 'failed' }} <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>*"
          }
        }
      ATTACHMENT: |
        {
          "color": "${{ (needs.publish.outputs.descriptor_exists == 'true' && needs.publish.outputs.publish_status == 'success' && needs.cleanup-branch.outputs.deleted != 'false') && 'good' || 'danger' }}",
          "fields": [
            {
              "title": "Release branch",
              "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/tree/${{ needs.pre-check.outputs.base_branch }}|${{ needs.pre-check.outputs.base_branch }}>",
              "short": true
            },
            {
              "title": "PR Number",
              "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/pull/${{ inputs.pr_number }}|#${{ inputs.pr_number }}>",
              "short": true
            },
            {
              "title": "Descriptor ID",
              "value": "${{ needs.publish.outputs.descriptor_id || 'N/A' }}",
              "short": true
            },
            {
              "title": "Commit",
              "value": "<https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }}|${{ inputs.head_sha }}>",
              "short": true
            },
            {
              "title": "Branch Cleanup",
              "value": "${{ needs.cleanup-branch.outputs.deleted == 'true' && 'Deleted' || (needs.cleanup-branch.outputs.deleted == 'skipped' && 'Skipped' || 'Failed') }}",
              "short": true
            }${{ needs.publish.outputs.descriptor_url != '' && format(',
            {{
              "title": "Descriptor URL",
              "value": "<{0}|View in FAR>",
              "short": false
            }}', needs.publish.outputs.descriptor_url) || '' }}${{ (needs.publish.outputs.descriptor_exists != 'true' || needs.publish.outputs.publish_status != 'success' || needs.cleanup-branch.outputs.deleted == 'false') && format(',
            {{
              "title": "Failure Reason",
              "value": "{0}",
              "short": false
            }}', needs.publish.outputs.failure_reason || needs.cleanup-branch.outputs.failure_reason || 'Operation failed') || '' }}
          ],
          "footer": "Eureka CI/CD"
        }
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.EUREKA_CI_APP_ID }}
          private-key: ${{ secrets.EUREKA_CI_APP_KEY }}
          owner: ${{ inputs.repo_owner }}
          repositories: ${{ inputs.repo_name }}

      - name: Get Repository Variables
        id: get-vars
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            try {
              const { data: variable } = await github.rest.actions.getRepoVariable({
                owner: '${{ inputs.repo_owner }}',
                repo: '${{ inputs.repo_name }}',
                name: 'SLACK_NOTIF_CHANNEL'
              });
              console.log(`Found SLACK_NOTIF_CHANNEL: ${variable.value}`);
              core.setOutput('team_channel', variable.value);
            } catch (error) {
              console.log(`SLACK_NOTIF_CHANNEL not found or not accessible: ${error.message}`);
              core.setOutput('team_channel', '');
            }

      - name: Send to Team Channel
        if: steps.get-vars.outputs.team_channel != ''
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ steps.get-vars.outputs.team_channel }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ env.ATTACHMENT }}
              ]
            }

      - name: Send to General Channel
        if: vars.GENERAL_SLACK_NOTIF_CHANNEL != ''
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.EUREKA_CI_SLACK_BOT_TOKEN }}
          errors: false
          payload: |
            {
              "channel": "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}",
              "text": "${{ env.TITLE_TEXT }}",
              "blocks": [
                ${{ env.TITLE_BLOCK }}
              ],
              "attachments": [
                ${{ env.ATTACHMENT }}
              ]
            }

  summarize:
    name: Workflow Summary
    needs: [pre-check, publish, notify, cleanup-branch]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Workflow Summary
        env:
          SHOULD_PROCESS: ${{ needs.pre-check.outputs.should_process }}
          SKIP_REASON: ${{ needs.pre-check.outputs.skip_reason }}
          BASE_BRANCH: ${{ needs.pre-check.outputs.base_branch }}
          HEAD_BRANCH: ${{ needs.pre-check.outputs.head_branch }}
          DESCRIPTOR_EXISTS: ${{ needs.publish.outputs.descriptor_exists }}
          DESCRIPTOR_ID: ${{ needs.publish.outputs.descriptor_id }}
          FAILURE_REASON: ${{ needs.publish.outputs.failure_reason }}
          PUBLISH_STATUS: ${{ needs.publish.outputs.publish_status }}
          DESCRIPTOR_URL: ${{ needs.publish.outputs.descriptor_url }}
        run: |
          {
            echo "### Descriptor Publish Summary"
            echo ""
            echo "**Repository:** \`${{ inputs.repo_owner }}/${{ inputs.repo_name }}\`"
            echo "**PR:** [#${{ inputs.pr_number }}](https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/pull/${{ inputs.pr_number }})"
            echo "**Commit:** [\`${{ inputs.head_sha }}\`](https://github.com/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/commit/${{ inputs.head_sha }})"
            echo "**Merged:** ${{ inputs.merged }}"
            echo ""

            echo "### Pre-Check Status"
            echo ""
            if [[ "$SHOULD_PROCESS" == "true" ]]; then
              echo "**Pre-Check:** Passed"
              echo "- **Base Branch:** $BASE_BRANCH"
              echo "- **Head Branch:** $HEAD_BRANCH"
            else
              echo "**Pre-Check:** Skipped"
              echo "- **Reason:** $SKIP_REASON"
            fi
            echo ""

            if [[ "$SHOULD_PROCESS" == "true" ]]; then
              echo "### Publication Status"
              echo ""
              if [[ "$DESCRIPTOR_EXISTS" == "true" ]]; then
                echo "- **Descriptor Found:** Yes"
                echo "- **Descriptor ID:** \`$DESCRIPTOR_ID\`"
                if [[ "$PUBLISH_STATUS" == "success" ]]; then
                  echo "- **Published to FAR:** Yes"
                  if [[ -n "$DESCRIPTOR_URL" ]]; then
                    echo "- **Descriptor URL:** [$DESCRIPTOR_URL]($DESCRIPTOR_URL)"
                  fi
                else
                  echo "- **Published to FAR:** No"
                  if [[ -n "$FAILURE_REASON" ]]; then
                    echo "- **Failure Reason:** $FAILURE_REASON"
                  fi
                fi
              else
                echo "- **Descriptor Found:** No"
                echo "- **Error:** Application descriptor (application.lock.json) not found"
              fi
              echo ""
            fi

            echo "### Notification Status"
            echo ""
            if [[ -n "${{ needs.notify.outputs.team_channel }}" ]]; then
              echo "**Team Channel** (\`${{ needs.notify.outputs.team_channel }}\`): Sent"
            else
              echo "**Team Channel:** Not configured"
            fi

            if [[ -n "${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}" ]]; then
              echo "**General Channel** (\`${{ vars.GENERAL_SLACK_NOTIF_CHANNEL }}\`): Sent"
            else
              echo "**General Channel:** Not configured"
            fi

            echo ""
            echo "---"
            echo ""
            echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> $GITHUB_STEP_SUMMARY